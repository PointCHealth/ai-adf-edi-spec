# EDI Event Store - EF Core Migrations

## Overview

This project contains EF Core migrations for the EDI Event Store database, **replacing the broken Microsoft.Build.Sql DACPAC SDK**.

### Why EF Core Migrations?

After 12 failed build attempts with Microsoft.Build.Sql (versions 0.1.12-preview and 0.2.3-preview), we discovered a fundamental parser bug that treats ANY qualified name as potentially ambiguous, even when no ambiguities exist. Microsoft's official documentation recommends using fully qualified names (`[schema].[table].[column]`), but their parser is broken and cannot handle this correctly.

**EF Core migrations provide**:
- ✅ Reliable deployment without parser bugs
- ✅ Version control for database schema
- ✅ Forward and backward migrations
- ✅ Idempotent deployments
- ✅ Production-ready tooling

## Database Schema

**6 Tables:**
- `DomainEvent` - Event store append-only table (37 columns)
- `TransactionBatch` - Source files/messages
- `TransactionHeader` - 834 transaction sets
- `Member` - Current state projection
- `Enrollment` - Member enrollment projections
- `EventSnapshot` - Performance optimization snapshots

**1 Sequence:**
- `EventSequence` - Global event ordering

**6 Views:**
- `vw_EventStream` - Complete event stream with context ✅
- `vw_ActiveEnrollments` - Active enrollments with demographics ✅
- `vw_BatchProcessingSummary` - Batch processing metrics ✅
- `vw_MemberEventHistory` - Member-specific event history ✅
- `vw_ProjectionLag` - Out-of-sync projection detection ✅
- `vw_EventTypeStatistics` - Event type distribution ✅

**8 Stored Procedures:**
- `usp_AppendEvent` - Append events to store ✅
- `usp_GetEventStream` - Retrieve event streams ✅
- `usp_GetLatestSnapshot` - Get latest snapshots ✅
- `usp_CreateSnapshot` - Create performance snapshots ✅
- `usp_UpdateMemberProjection` - Update member projections ✅
- `usp_UpdateEnrollmentProjection` - Update enrollment projections ✅
- `usp_ReverseBatch` - Reverse processing batch ✅
- `usp_ReplayEvents` - Replay events for projections ✅

**Status**: ✅ **All views and stored procedures included in initial migration**

## Project Structure

```
EDI.EventStore.Migrations/
├── Entities/
│   ├── DomainEvent.cs
│   ├── TransactionBatch.cs
│   ├── TransactionHeader.cs
│   ├── Member.cs
│   ├── Enrollment.cs
│   └── EventSnapshot.cs
├── Data/
│   ├── EventStoreDbContext.cs
│   └── EventStoreDbContextFactory.cs
└── Migrations/
    └── (generated by EF Core)
```

## Prerequisites

- .NET 8.0 SDK
- Entity Framework Core Tools
- Azure SQL Database or SQL Server 2019+

## Installation

Install EF Core CLI tools globally:

```powershell
dotnet tool install --global dotnet-ef
```

## Creating Initial Migration

```powershell
cd c:\repos\ai-adf-edi-spec\infra\ef-migrations\EDI.EventStore.Migrations\EDI.EventStore.Migrations

# Create initial migration
dotnet ef migrations add InitialCreate --context EventStoreDbContext
```

## Applying Migrations

### Local Development

```powershell
# Update local database
dotnet ef database update --context EventStoreDbContext --connection "Server=(localdb)\\mssqllocaldb;Database=EDI_EventStore;Trusted_Connection=True;"
```

### Azure SQL (Dev Environment)

```powershell
# Update Azure SQL Dev database
$connectionString = "Server=tcp:edi-sql-dev.database.windows.net,1433;Initial Catalog=EventStore;Persist Security Info=False;User ID=sqladmin;Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"

dotnet ef database update --context EventStoreDbContext --connection $connectionString
```

### Azure SQL (Prod Environment)

```powershell
# Update Azure SQL Prod database (use with caution)
$connectionString = "Server=tcp:edi-sql-prod.database.windows.net,1433;Initial Catalog=EventStore;Persist Security Info=False;User ID=sqladmin;Password={your_password};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"

dotnet ef database update --context EventStoreDbContext --connection $connectionString
```

## Generate SQL Scripts (for Review/CI/CD)

Instead of applying directly, you can generate SQL scripts for review:

```powershell
# Generate script for all pending migrations
dotnet ef migrations script --context EventStoreDbContext --idempotent --output EventStore_Migration.sql

# Generate script for specific migration range
dotnet ef migrations script FromMigration ToMigration --context EventStoreDbContext --idempotent --output EventStore_Update.sql
```

## Adding Views and Stored Procedures

Views and stored procedures will be added as raw SQL in migrations:

```powershell
# After creating initial migration, edit the migration file and add:

migrationBuilder.Sql(@"
CREATE VIEW dbo.vw_EventStream AS
SELECT ...
");

migrationBuilder.Sql(@"
CREATE PROCEDURE dbo.usp_AppendEvent AS
BEGIN
    ...
END
");
```

## Rollback Migration

```powershell
# Roll back to previous migration
dotnet ef database update PreviousMigrationName --context EventStoreDbContext

# Roll back all migrations
dotnet ef database update 0 --context EventStoreDbContext
```

## List Migrations

```powershell
# List all migrations and their status
dotnet ef migrations list --context EventStoreDbContext
```

## Remove Last Migration

```powershell
# Remove the most recent migration (if not applied)
dotnet ef migrations remove --context EventStoreDbContext
```

## CI/CD Integration

### Azure DevOps Pipeline Example

```yaml
- task: DotNetCoreCLI@2
  displayName: 'Generate Migration Script'
  inputs:
    command: 'custom'
    custom: 'ef'
    arguments: 'migrations script --context EventStoreDbContext --idempotent --output $(Build.ArtifactStagingDirectory)/EventStore_Migration.sql'
    workingDirectory: 'infra/ef-migrations/EDI.EventStore.Migrations/EDI.EventStore.Migrations'

- task: SqlAzureDacpacDeployment@1
  displayName: 'Apply Migration to Azure SQL'
  inputs:
    azureSubscription: 'Azure-ServiceConnection'
    authenticationType: 'servicePrincipal'
    serverName: 'edi-sql-dev.database.windows.net'
    databaseName: 'EventStore'
    deployType: 'SqlTask'
    sqlFile: '$(Build.ArtifactStagingDirectory)/EventStore_Migration.sql'
```

### GitHub Actions Example

```yaml
- name: Generate Migration Script
  run: |
    dotnet ef migrations script --context EventStoreDbContext --idempotent --output EventStore_Migration.sql
  working-directory: ./infra/ef-migrations/EDI.EventStore.Migrations/EDI.EventStore.Migrations

- name: Apply Migration
  run: |
    sqlcmd -S edi-sql-dev.database.windows.net -d EventStore -U ${{ secrets.SQL_USER }} -P ${{ secrets.SQL_PASSWORD }} -i EventStore_Migration.sql
```

## Benefits Over DACPAC

1. **No Parser Bugs**: EF Core migrations work reliably without hallucinating ambiguities
2. **Version Control**: Each migration is a file you can review, test, and version control
3. **Idempotent**: Can be run multiple times safely
4. **Rollback Support**: Can roll back to previous states
5. **Cross-Platform**: Works on Windows, Linux, macOS
6. **Well-Documented**: Extensive Microsoft documentation and community support
7. **Production-Ready**: Used by thousands of production applications worldwide

## Troubleshooting

### "No DbContext was found"
- Ensure you're in the project directory containing the `.csproj` file
- Use `--project` and `--startup-project` flags if needed

### "Unable to create migrations"
- Verify Entity Framework Core tools are installed: `dotnet ef --version`
- Check that `EventStoreDbContextFactory` is in the same assembly

### "Login failed for user"
- Verify connection string is correct
- Check Azure SQL firewall rules allow your IP
- Ensure SQL authentication is enabled

## Next Steps

1. ✅ Create initial migration
2. ✅ Test migration against local SQL Server
3. ✅ Add views as raw SQL
4. ✅ Add stored procedures as raw SQL
5. ✅ Deploy to Azure SQL Dev
6. ✅ Verify all objects created correctly
7. ✅ Integrate into CI/CD pipeline

## Documentation

- [EF Core Migrations](https://learn.microsoft.com/en-us/ef/core/managing-schemas/migrations/)
- [Azure SQL Deployment](https://learn.microsoft.com/en-us/azure/sql-database/sql-database-deploy-to-azure)
- [Event Sourcing Pattern](https://learn.microsoft.com/en-us/azure/architecture/patterns/event-sourcing)
